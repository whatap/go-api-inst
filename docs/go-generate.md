# go:generate Mode

Uses Go's `go generate` mechanism to directly modify source code.

## Overview

```bash
# 1. Add directive
whatap-go-inst init

# 2. Add dependencies (required!)
go get github.com/whatap/go-api@latest
go mod tidy

# 3. Code generation (inject monitoring code)
go generate ./...

# 4. Build
go build ./...
```

## How It Works

### init Command

`whatap-go-inst init` creates `whatap_inst_generate.go` file in your project:

```go
// Code generated by whatap-go-inst init; DO NOT EDIT.

//go:generate whatap-go-inst generate

package main
```

### go generate Execution Flow

```
┌─────────────────────────────────────────────────────────────────┐
│  go generate ./...                                              │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  //go:generate whatap-go-inst generate found                    │
│  → executes whatap-go-inst generate                             │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  Scan all .go files in current directory                        │
│                                                                 │
│  For each file:                                                 │
│  1. Parse AST                                                   │
│  2. Detect frameworks                                           │
│  3. Inject monitoring code                                      │
│  4. Overwrite original file                                     │
└─────────────────────────────────────────────────────────────────┘
```

## Usage

### Initial Setup

```bash
# Navigate to project directory
cd myproject

# Add go:generate directive
whatap-go-inst init

# Add dependencies (required!)
go get github.com/whatap/go-api@latest
go mod tidy
```

Generated file (`whatap_inst_generate.go`):
```go
// Code generated by whatap-go-inst init; DO NOT EDIT.

//go:generate whatap-go-inst generate

package main
```

### Code Generation

```bash
# Inject monitoring code
go generate ./...
```

Output:
```
Transformed: ./main.go
Transformed: ./handler/user.go
Transformed: ./handler/product.go
```

### Build

```bash
# Normal build (instrumentation code already in source)
go build ./...
```

### Remove Instrumentation

```bash
# Remove go:generate directive
whatap-go-inst uninit

# Or delete manually
rm whatap_inst_generate.go
```

## Example

### Full Workflow

**1. Original code (main.go):**
```go
package main

import (
    "github.com/gin-gonic/gin"
)

func main() {
    r := gin.Default()
    r.GET("/", func(c *gin.Context) {
        c.JSON(200, gin.H{"message": "hello"})
    })
    r.Run(":8080")
}
```

**2. Run init and add dependencies:**
```bash
$ whatap-go-inst init
go:generate directive added.

$ go get github.com/whatap/go-api@latest
$ go mod tidy
```

**3. Run go generate:**
```bash
$ go generate ./...
Transformed: ./main.go
```

**4. Transformed code (main.go):**
```go
package main

import (
    "github.com/gin-gonic/gin"
    "github.com/whatap/go-api/instrumentation/github.com/gin-gonic/gin/whatapgin"
    "github.com/whatap/go-api/trace"
)

func main() {
    trace.Init(nil)
    defer trace.Shutdown()
    r := gin.Default()
    r.GET("/", func(c *gin.Context) {
        c.JSON(200, gin.H{"message": "hello"})
    })
    r.Run(":8080")
}
```

**5. Build:**
```bash
$ go build -o myapp .
```

### Git Workflow

```bash
# Work without instrumentation during development
git checkout main
go build ./...

# Add instrumentation on release branch
git checkout -b release/v1.0
whatap-go-inst init
go get github.com/whatap/go-api@latest
go mod tidy
go generate ./...
git add .
git commit -m "Add instrumentation for release"

# Build and deploy
go build -o myapp .
```

## Environment Variables

`go generate` sets the following environment variables:

| Variable | Description | Example |
|----------|-------------|---------|
| `$GOFILE` | Current file being processed | `main.go` |
| `$GOPACKAGE` | Current package name | `main` |
| `$GOLINE` | Line number of directive | `3` |
| `$GOARCH` | Target architecture | `amd64` |
| `$GOOS` | Target OS | `linux` |

## Advantages

| Advantage | Description |
|-----------|-------------|
| **Version controllable** | Can commit transformed source to Git |
| **Faster build time** | No transformation needed on every build |
| **Easy debugging** | Can directly inspect actual running code |
| **No tool required** | whatap-go-inst not needed at build time |

## Disadvantages

| Disadvantage | Description |
|--------------|-------------|
| **Source modification** | Original source is directly modified |
| **Sync required** | Must run `go generate` on every original change |
| **Git conflicts possible** | Auto-generated code can cause conflicts |

## Git Configuration

### .gitignore

To exclude instrumented code from Git:

```gitignore
# whatap-go-inst generated files
whatap_inst_generate.go
whatap_inst.tool.go
```

### .gitattributes

Mark auto-generated code:

```gitattributes
whatap_inst_generate.go linguist-generated=true
whatap_inst.tool.go linguist-generated=true
```

## Makefile Integration

```makefile
.PHONY: instrument build clean

# Inject instrumentation code
instrument:
	whatap-go-inst init
	go get github.com/whatap/go-api@latest
	go mod tidy
	go generate ./...

# Build (with instrumentation)
build-instrumented: instrument
	go build -o bin/myapp ./...

# Normal build (no instrumentation)
build:
	go build -o bin/myapp ./...

# Remove instrumentation
clean-instrument:
	whatap-go-inst uninit
	git checkout -- .  # Restore original
```

## Important Notes

### 1. Duplicate Execution Prevention

Running `go generate` on already instrumented code does not cause duplicate insertion. Files with whatap imports detected are skipped.

### 2. Skipped Files

- `_test.go` files
- `_generate.go` files
- Files containing `generated` string
- `vendor/` directory
- `.git/` directory

### 3. Restoring Original

```bash
# Restore with Git
git checkout -- .

# Or use remove command
whatap-go-inst remove -s . -o ./clean
cp ./clean/* ./
```

## Troubleshooting

### go generate Not Running

```bash
# Check go:generate directive
grep -r "go:generate whatap-go-inst" .

# Manual execution
whatap-go-inst generate
```

### Compile Error After Transformation

```bash
# Check for missing imports
go mod tidy

# Add whatap/go-api dependency
go get github.com/whatap/go-api@latest
```

## Next Steps

- [Build Wrapper Mode](./build-wrapper.md) - No source modification approach
- [toolexec Mode](./toolexec.md)
- [Direct Source Modification Mode](./source-inject.md)
